name: Supabase Keep Alive

on:
  schedule:
    - cron: '0 */6 * * *' # Run every 6 hours to keep Supabase active
  workflow_dispatch: # Allows manual triggering

permissions: {}

jobs:
  keep_alive:
    runs-on: ubuntu-latest
    steps:
      - name: Check environment variables
        id: check_env
        run: |
          if [ -z "${{ secrets.VITE_SUPABASE_URL }}" ] || [ -z "${{ secrets.VITE_SUPABASE_ANON_KEY }}" ]; then
            echo "::warning::Supabase URL or Anon Key is not set as GitHub secrets."
            echo "Please add VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY to your repository secrets."
            exit 1
          fi
          echo "SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}" >> $GITHUB_ENV
          echo "SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }}" >> $GITHUB_ENV

      - name: Ping Supabase REST API
        if: steps.check_env.outcome == 'success'
        env:
          SUPABASE_URL: ${{ env.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ env.SUPABASE_ANON_KEY }}
        run: |
          echo "Pinging Supabase REST API at ${SUPABASE_URL}"
          response=$(curl --request GET \
            --url "${SUPABASE_URL}/rest/v1/" \
            --header "apikey: ${SUPABASE_ANON_KEY}" \
            --header "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            --max-time 30 \
            --retry 2 \
            --write-out "\n%{http_code}" \
            --silent --show-error)
          
          http_code=$(echo "$response" | tail -n1)
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 400 ]; then
            echo "✅ REST API ping successful (HTTP $http_code)"
          else
            echo "⚠️ REST API ping returned HTTP $http_code, but continuing..."
          fi

      - name: Ping Heartbeat Edge Function
        if: steps.check_env.outcome == 'success'
        env:
          SUPABASE_URL: ${{ env.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ env.SUPABASE_ANON_KEY }}
        run: |
          echo "Pinging Heartbeat Edge Function at ${SUPABASE_URL}/functions/v1/heartbeat"
          response=$(curl --request GET \
            --url "${SUPABASE_URL}/functions/v1/heartbeat" \
            --header "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            --header "Content-Type: application/json" \
            --max-time 30 \
            --retry 3 \
            --write-out "\n%{http_code}" \
            --silent --show-error)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "Response: $body"
          
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 400 ]; then
            echo "✅ Heartbeat function ping successful (HTTP $http_code)"
            echo "✅ Supabase database kept alive"
          else
            echo "⚠️ Heartbeat function returned HTTP $http_code"
            echo "This may indicate the function needs to be deployed or there's a configuration issue"
            exit 1
          fi

      - name: Ping get-config Edge Function
        if: steps.check_env.outcome == 'success'
        env:
          SUPABASE_URL: ${{ env.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ env.SUPABASE_ANON_KEY }}
        continue-on-error: true
        run: |
          echo "Pinging get-config Edge Function for additional warmup"
          response=$(curl --request GET \
            --url "${SUPABASE_URL}/functions/v1/get-config" \
            --header "Content-Type: application/json" \
            --max-time 30 \
            --write-out "\n%{http_code}" \
            --silent --show-error)
          
          http_code=$(echo "$response" | tail -n1)
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 400 ]; then
            echo "✅ get-config function also warmed up (HTTP $http_code)"
          else
            echo "ℹ️ get-config returned HTTP $http_code (this is optional)"
          fi
