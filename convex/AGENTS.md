# AGENTS (convex)

## Package Identity
- Convex backend handling auth, expenses, categories/locations, recurring items, settlements, savings goals, receipts, and email notifications.
- Uses Convex Auth with email/password (bcrypt), validation helpers, and Resend for email actions.

## Setup & Run
- Dev server: `bun run dev:convex` (or `npx convex dev`) with `VITE_CONVEX_URL` set for the frontend.
- Configure secrets via `npx convex env set` (e.g., `SITE_URL`, `JWT_PRIVATE_KEY`, `RESEND_API_KEY`, `EMAIL_FROM`).
- Set user passwords: `bunx convex run password:setPassword '{"email": "user@example.com", "password": "password"}' --prod`
- Typecheck: `bunx --bun tsc -p convex/tsconfig.json`.
- Lint: `bun run lint` (ignores `convex/_generated`).
- Tests: `bun test convex/utils/validation.test.ts`.

## Patterns & Conventions
- Require authentication before DB access using `requireAuthenticatedUser` (`convex/utils/auth.ts`); see `expenses.ts#getByMonth`.
- Validate inputs with `assertValidDate`, `assertValidMonth`, `assertPositiveAmount` (`convex/utils/validation.ts`) before writes/filters.
- Use indexes defined in `convex/schema.ts` with `.withIndex` for queries (e.g., `categories.by_name`, `expenses.by_month`).
- Normalize updates by filtering undefined fields as in `expenses.update`; derive `month` from `date` when updating.
- Use `action`/`internalAction` for side effects like emails (`convex/email.ts`) and check for required env keys.
- Keep `_generated/*` untouched—regenerated by Convex tooling.
- ✅ DO import `Id` and API types from `_generated/dataModel`/`_generated/api`.
- ✅ DO gate mutations/queries with auth + validation helpers.
- ❌ DON’T query full tables without indexes when a filtered index exists; avoid unbounded `.collect()` unless necessary.
- ❌ DON’T attempt to onboard new users without updating the closed-auth logic in `convex/auth.ts` (only existing emails allowed).

## Touch Points / Key Files
- Schema & config: `convex/schema.ts`, `convex/convex.config.ts`, `convex/auth.config.ts`
- Auth plumbing: `convex/auth.ts`, `convex/http.ts`
- Utilities/tests: `convex/utils/auth.ts`, `convex/utils/validation.ts`, `convex/utils/validation.test.ts`
- Domain logic: `convex/expenses.ts`, `categories.ts`, `locations.ts`, `recurring.ts`, `settlements.ts`, `savingsGoals.ts`, `monthData.ts`, `receipts.ts`, `analytics.ts`
- Side effects/maintenance: `convex/email.ts`, `convex/cleanup.ts`, `convex/migration.ts`

## JIT Index Hints
- List functions: `find convex -maxdepth 1 -name "*.ts" ! -name "convex.config.ts"`
- Search mutations/queries: `grep -R "mutation(" convex` and `grep -R "query(" convex`
- Find validations: `grep -R "assertValid" convex`
- Index usage: `grep -R "withIndex" convex`
- Run single test: `bun test convex/utils/validation.test.ts`

## Common Gotchas
- Auth is closed: `convex/auth.ts` only allows existing users with set passwords to sign in; no new user registration.
- Missing `RESEND_API_KEY`/`EMAIL_FROM` will log errors and skip sending emails (`convex/email.ts`).
- Set Convex env vars via `npx convex env set`; frontend `.env` alone is not enough.
- Avoid editing `_generated` files; re-run Convex tooling instead.

## Pre-PR Checks
- `bun run lint && bunx --bun tsc -p convex/tsconfig.json && bun test convex/utils/validation.test.ts`
