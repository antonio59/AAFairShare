# AAFairShare – CLAUDE Rules (root)

## Project Identity
- **Type:** Standard single-project repo (Vite React SPA + Convex backend)
- **Stack:** TypeScript (non-strict), React 18, TanStack Query, Tailwind + Radix/shadcn UI, Convex auth/functions, Bun toolchain
- **Architecture:** Frontend in `src/` calling Convex functions in `convex/`; PWA build via Vite; CI via GitHub Actions (quality, CodeQL, Netlify deploy)
- **Authoritative:** This CLAUDE.md is the top-level rule set; subdirectories extend it and take precedence locally

## Universal Development Rules (MUST/SHOULD/MUST NOT)
### MUST
- **MUST** keep changes consistent with `@/` alias and functional React patterns
- **MUST** run lint, typecheck, tests, and build before PRs (`bun run lint && bun x --bun tsc --noEmit && bun test && bun run build`)
- **MUST** gate backend operations with auth/validation helpers when touching Convex functions
- **MUST** protect secrets: never commit `.env` or keys; follow `.env.example` and Convex env via `npx convex env set`

### SHOULD
- **SHOULD** reuse hooks in `src/hooks/useConvexData.ts` and layouts in `src/components/layout/*`
- **SHOULD** keep components small and typed; prefer explicit props over `any`
- **SHOULD** favor utility-first Tailwind with shadcn primitives (`src/components/ui/*`)
- **SHOULD** document demo-mode impacts when toggling `VITE_GUEST_MODE`

### MUST NOT
- **MUST NOT** bypass validations or auth in Convex (`requireAuthenticatedUser`, `assertValid*`)
- **MUST NOT** edit `convex/_generated/*` directly (regenerated by Convex)
- **MUST NOT** force push, rewrite history, or run destructive shell commands (`rm -rf /`, dropping data) without approval
- **MUST NOT** add secrets to logs or commit history; scrub PII

## Core Commands
### Development
- Install deps: `bun install`
- Frontend dev: `bun run dev` (Vite, port 8080)
- Convex dev backend: `bun run dev:convex`

### Quality & Build
- Lint: `bun run lint`
- Typecheck: `bunx --bun tsc --noEmit`
- Tests: `bun test`
- Build: `bun run build`
- Preview build: `bun run preview`

### Pre-PR Gate
```bash
bun run lint && bunx --bun tsc --noEmit && bun test && bun run build
```

## Project Structure Map
- **Frontend SPA:** `src/` → [see src/CLAUDE.md](src/CLAUDE.md)
- **Convex backend:** `convex/` → [see convex/CLAUDE.md](convex/CLAUDE.md)
- **Automation:** `scripts/capture-screens.ts` (screenshot capture)
- **CI/CD:** `.github/workflows/*.yml` (code quality, CodeQL, Netlify deploy, dependency review, keep-alive)

## Quick Find Commands (JIT navigation)
- List pages/routes: `find src/pages -name "*.tsx"`
- Find Convex queries/mutations: `grep -R "\bmutation(\|query(" convex`
- Locate UI primitives: `ls src/components/ui`
- Locate data hooks: `grep -R "useConvexData" -n src/hooks src/pages`
- Types: `find src/types -name "*.ts"`

## Security & Secrets
- **NEVER** commit `.env`, `.env.production`, or keys; use `.env.example` for shape
- Frontend expects `VITE_CONVEX_URL`; demo mode via `VITE_GUEST_MODE=true` (disables uploads, uses mock data)
- Convex secrets (`SITE_URL`, `JWT_PRIVATE_KEY`, `RESEND_API_KEY`, `EMAIL_FROM`) set with `npx convex env set`
- Avoid logging user data; redact emails and PII

## Git Workflow
- Branch from `main`; use Conventional Commit prefixes (`feat:`, `fix:`, `chore:` ...)
- Keep PRs small; ensure CI (lint/typecheck/test/build) is green
- Prefer squash merge; delete merged branches
- No force pushes to shared branches without approval

## Testing Strategy
- Tests run with `bun test`; current coverage in `convex/utils/validation.test.ts`
- Add colocated `*.test.ts`/`*.test.tsx` alongside new logic
- Mock Convex calls via hooks abstractions; avoid hitting real services in unit tests
- Run focused tests for touched areas plus full suite before PR

## Available Tools & Permissions
- **Allowed:** Read/write repo files, run `bun` scripts, run lint/typecheck/tests/build
- **Ask first:** Editing env files, changing CI workflows, running network-affecting scripts, force push
- **Blocked:** Direct edits to `convex/_generated/*`, destructive commands (`rm -rf /`, dropping data), committing secrets

## Directory-Specific CLAUDE.md Files
- Frontend work: [src/CLAUDE.md](src/CLAUDE.md)
- Convex backend: [convex/CLAUDE.md](convex/CLAUDE.md)

## Hooks & Automation Notes (Claude Code)
- Use pre-tool hooks to block dangerous shell (`rm -rf`, force-push) and post-tool hooks to optionally run targeted checks on edited TS/TSX
- Custom commands live in `.claude/commands/`; see provided `/review`, `/fix-issue`, `/migrate-schema`
- MCP servers can be added for GitHub and search (see `.mcp.json` guidance)

## Dangerous Patterns to Block
- Removing data or auth checks from Convex mutations/queries
- Hardcoding secrets or external URLs in client code
- Upload handling without size/type checks (see `src/components/expense/ReceiptUpload.tsx`)
- Bypassing demo-mode guard (`DEMO_MODE`) when testing upload/receipt flows

## Definition of Done
- Quality gate passes: lint, typecheck, tests, build
- Routes wired in `src/App.tsx`; data flows via `src/hooks/useConvexData.ts`
- No secrets or PII leaked; docs/CLAUDE hierarchy updated if structure changes
